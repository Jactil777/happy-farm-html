<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¼€å¿ƒå†œåœº - ç»å…¸å¤åˆ»ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Microsoft Yahei", "SimHei", sans-serif;
        }

        body {
            background: linear-gradient(120deg, #87CEEB 0%, #90EE90 85%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px;
            background-attachment: fixed;
            position: relative;
        }

        /* ç™»å½•/æ³¨å†Œç•Œé¢ */
        .auth-container {
            width: 100%;
            max-width: 400px;
            background: #F5F5DC;
            border: 8px solid #8B4513;
            border-radius: 12px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            position: relative;
        }

        .auth-container::before {
            content: "ğŸŒ±";
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 30px;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 2px solid #D2B48C;
        }

        .auth-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #8B4513;
            transition: all 0.3s;
        }

        .auth-tab.active {
            color: #228B22;
            border-bottom: 2px solid #228B22;
            margin-bottom: -2px;
        }

        .auth-form {
            display: none;
            flex-direction: column;
            gap: 15px;
        }

        .auth-form.active {
            display: flex;
        }

        .auth-form input {
            padding: 12px 15px;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            font-size: 16px;
            background: #FFF8DC;
        }

        .auth-form input:focus {
            outline: none;
            border-color: #228B22;
        }

        .auth-btn {
            padding: 12px;
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
            border: 2px solid #006400;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
        }

        /* è®°ä½å¯†ç å¤é€‰æ¡† */
        .remember-password {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: #8B4513;
            cursor: pointer;
            user-select: none;
        }

        .remember-password input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #228B22;
        }

        /* ç™»å½•é¡µå¯¼å…¥å­˜æ¡£æŒ‰é’® */
        .import-save-btn {
            margin-top: 15px;
            padding: 10px;
            background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%);
            border: 2px solid #00008B;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .import-save-btn:hover {
            background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(65, 105, 225, 0.3);
        }

        .auth-welcome {
            text-align: center;
            font-size: 20px;
            font-weight: bold;
            color: #228B22;
            margin-bottom: 20px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
        }

        .logout-btn {
            padding: 8px 16px;
            background: #CD5C5C;
            border: 2px solid #8B0000;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            margin-top: 10px;
            transition: all 0.2s;
        }

        .logout-btn:hover {
            background: #B22222;
            transform: scale(1.05);
        }

        /* æ¸¸æˆå¤´éƒ¨æŒ‰é’®åŒº */
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .export-save-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%);
            border: 2px solid #00008B;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .export-save-btn:hover {
            background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
            transform: scale(1.05);
        }

        .auto-save-indicator {
            font-size: 12px;
            color: #32CD32;
            padding: 4px 8px;
            background: rgba(50, 205, 50, 0.1);
            border-radius: 4px;
            display: none;
        }

        .auto-save-indicator.active {
            display: inline-block;
        }

        /* æ¸¸æˆç•Œé¢ */
        .game-container {
            display: none;
            width: 100%;
            max-width: 1200px;
            background: rgba(255, 255, 255, 0.85);
            border: 8px solid #8B4513;
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
        }

        /* æ¸¸æˆä¸»ä½“åŒºåŸŸ */
        .game-main {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        /* å·¦ä¾§å†œåœºåŒºåŸŸ */
        .farm-area {
            flex: 1;
        }

        .game-header {
            background: linear-gradient(135deg, #DEB887 0%, #D2B48C 100%);
            border: 3px solid #8B4513;
            border-radius: 10px;
            padding: 15px 20px;
            margin-bottom: 25px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
        }

        /* ç”¨æˆ·ä¿¡æ¯æ ·å¼ */
        .user-info {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            margin-bottom: 8px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 3px solid #8B4513;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 3px 8px rgba(0, 0, 0, 0.2);
        }

        .user-name {
            font-size: 18px;
            font-weight: bold;
            color: #8B4513;
            text-shadow: 1px 1px 2px rgba(255, 215, 0, 0.3);
        }

        .user-level {
            font-size: 14px;
            color: #DAA520;
        }

        .gold-display {
            font-size: 22px;
            font-weight: bold;
            color: #DAA520;
            text-shadow: 1px 1px 2px #8B4513;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .time-display {
            font-size: 16px;
            color: #8B4513;
            margin-bottom: 5px;
            line-height: 1.4;
        }

        /* å†œåœºç”°åœ° */
        .farm-container {
            display: grid;
            grid-template-columns: repeat(5, 1fr);
            gap: 8px;
            margin-bottom: 20px;
            padding: 10px;
            background: #8FBC8F;
            border: 5px solid #8B4513;
            border-radius: 10px;
        }

        .plot {
            width: 100px;
            height: 100px;
            background: repeating-linear-gradient(45deg,
                    #8B4513,
                    #8B4513 10px,
                    #A0522D 10px,
                    #A0522D 20px);
            border: 3px solid #654321;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .plot:hover {
            border-color: #DAA520;
            transform: translateY(-3px);
            box-shadow: 0 8px 15px rgba(0, 0, 0, 0.2);
        }

        /* ä½œç‰©ç”Ÿé•¿é˜¶æ®µ */
        .plot.seedling {
            background: linear-gradient(45deg, #556B2F, #6B8E23);
        }

        .plot.growing {
            background: linear-gradient(45deg, #6B8E23, #7CCD7C);
        }

        .plot.ready {
            background: linear-gradient(45deg, #FFD700, #FFA500);
            animation: harvest-pulse 1.5s infinite alternate;
        }

        @keyframes harvest-pulse {
            from {
                transform: scale(1);
                box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
            }

            to {
                transform: scale(1.05);
                box-shadow: 0 8px 20px rgba(255, 215, 0, 0.6);
            }
        }

        /* è¡¨æƒ…ç¬¦å·ä½œç‰© */
        .crop-emoji {
            font-size: 40px;
            transition: all 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }

        .plot.seedling .crop-emoji {
            transform: scale(0.5) translateY(10px);
            filter: brightness(0.7) saturate(0.5);
            opacity: 0.8;
            animation: seedling-grow 1s ease-out;
        }

        .plot.growing .crop-emoji {
            transform: scale(0.8) translateY(5px);
            filter: brightness(0.9) saturate(0.8);
            opacity: 0.9;
        }

        .plot.ready .crop-emoji {
            transform: scale(1.1) translateY(0);
            filter: brightness(1.3) saturate(1.5) hue-rotate(15deg);
            animation: crop-glow 1.5s infinite alternate;
        }

        @keyframes crop-glow {
            from {
                filter: brightness(1.3) saturate(1.5) hue-rotate(15deg) drop-shadow(0 0 8px rgba(255, 215, 0, 0.6));
                transform: scale(1.1) translateY(0);
            }

            to {
                filter: brightness(1.5) saturate(1.8) hue-rotate(15deg) drop-shadow(0 0 15px rgba(255, 215, 0, 0.9));
                transform: scale(1.15) translateY(-2px);
            }
        }

        @keyframes seedling-grow {
            0% {
                transform: scale(0.2) translateY(20px);
                opacity: 0.3;
            }

            100% {
                transform: scale(0.5) translateY(10px);
                opacity: 0.8;
            }
        }

        /* ä½œç‰©æˆç†Ÿæ—¶é—´æ˜¾ç¤º */
        .crop-time {
            position: absolute;
            bottom: 3px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.75);
            color: #FFF;
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 10px;
            font-weight: bold;
            white-space: nowrap;
            z-index: 10;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.5);
        }

        .plot.ready .crop-time {
            background: rgba(255, 215, 0, 0.9);
            color: #8B4513;
            animation: time-pulse 1s infinite alternate;
        }

        @keyframes time-pulse {
            from {
                transform: translateX(-50%) scale(1);
            }

            to {
                transform: translateX(-50%) scale(1.1);
            }
        }

        /* æœªå¼€å¦åœŸåœ°æ ·å¼ */
        .plot.locked {
            background: repeating-linear-gradient(45deg,
                    #D2B48C,
                    #D2B48C 10px,
                    #C4A574 10px,
                    #C4A574 20px);
            border: 3px dashed #8B7355;
            opacity: 0.6;
            cursor: not-allowed;
            position: relative;
        }

        .plot.locked::before {
            content: 'ğŸ”’';
            position: absolute;
            font-size: 30px;
            opacity: 0.7;
        }

        .plot.locked:hover {
            transform: none;
            box-shadow: none;
            border-color: #8B7355;
        }

        /* åŠŸèƒ½æŒ‰é’®åŒº */
        .reclaim-section {
            margin-top: 10px;
            text-align: center;
            margin-bottom: 20px;
            display: flex;
            justify-content: center;
            gap: 15px;
            flex-wrap: wrap;
        }

        .reclaim-btn,
        .answer-btn,
        .remove-plot-btn,
        .harvest-all-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #DAA520 0%, #FFD700 100%);
            border: 3px solid #B8860B;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin: 0 5px;
        }

        .remove-plot-btn {
            background: linear-gradient(135deg, #CD5C5C 0%, #B22222 100%);
            border-color: #8B0000;
        }

        .harvest-all-btn {
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
            border-color: #006400;
        }

        .reclaim-btn:hover,
        .answer-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(218, 165, 32, 0.3);
            background: linear-gradient(135deg, #FFD700 0%, #DAA520 100%);
        }

        .remove-plot-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(220, 100, 100, 0.3);
            background: linear-gradient(135deg, #B22222 0%, #CD5C5C 100%);
        }

        .harvest-all-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(34, 139, 34, 0.3);
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
        }

        /* ç­”é¢˜æµ®åŠ¨çª—å£ */
        .answer-modal {
            display: none;
            position: fixed;
            top: 150px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1002;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .answer-modal.dragging {
            cursor: move;
            opacity: 0.9;
        }

        /* ä¸ªäººä¿¡æ¯æµ®åŠ¨çª—å£ */
        .user-modal {
            display: none;
            position: fixed;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .user-modal.dragging {
            cursor: move;
            opacity: 0.9;
        }

        .user-modal-content {
            background: #F5F5DC;
            border: 8px solid #8B4513;
            border-radius: 12px;
            padding: 0;
            width: 100%;
            max-width: 600px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* çª—å£æ ‡é¢˜æ  */
        .modal-titlebar {
            background: linear-gradient(135deg, #8B4513 0%, #A0522D 100%);
            padding: 12px 20px;
            border-radius: 4px 4px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .modal-titlebar:active {
            cursor: grabbing;
        }

        .modal-title {
            color: #FFF;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .user-modal-header {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #D2B48C;
        }

        .user-modal-avatar {
            width: 60px;
            height: 60px;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 3px solid #8B4513;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .user-modal-info {
            flex: 1;
        }

        .user-modal-name {
            font-size: 22px;
            font-weight: bold;
            color: #8B4513;
        }

        .user-modal-level {
            font-size: 16px;
            color: #DAA520;
            margin-top: 5px;
        }

        /* ç»éªŒæ¡æ ·å¼ */
        .exp-bar-container {
            width: 100%;
            height: 15px;
            background: #D2B48C;
            border-radius: 8px;
            margin: 10px 0;
            overflow: hidden;
        }

        .exp-bar {
            height: 100%;
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-radius: 8px;
            transition: width 0.3s ease;
        }

        .exp-text {
            font-size: 14px;
            color: #8B4513;
            margin-bottom: 15px;
        }

        /* ä»“åº“æ ·å¼ */
        .warehouse-title {
            font-size: 18px;
            font-weight: bold;
            color: #8B4513;
            margin: 20px 0 15px;
        }

        .warehouse-list {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 25px;
        }

        .warehouse-item {
            flex: 1;
            min-width: 120px;
            padding: 15px;
            background: #FFF8DC;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .crop-icon {
            font-size: 30px;
        }

        .crop-name {
            font-size: 16px;
            color: #8B4513;
            font-weight: bold;
        }

        .crop-count {
            font-size: 14px;
            color: #654321;
        }

        .sell-btn {
            padding: 8px 15px;
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
            border: 2px solid #006400;
            border-radius: 6px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            margin-top: 5px;
            transition: all 0.2s;
        }

        .sell-btn:hover {
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
            transform: scale(1.05);
        }

        /* å¯¼å‡º/å¯¼å…¥æŒ‰é’®æ ·å¼ */
        .backup-buttons {
            display: flex;
            gap: 10px;
            margin-top: 25px;
            padding-top: 20px;
            border-top: 2px solid #D2B48C;
        }

        .backup-btn {
            flex: 1;
            padding: 12px;
            background: linear-gradient(135deg, #4169E1 0%, #1E90FF 100%);
            border: 2px solid #00008B;
            border-radius: 8px;
            color: white;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 5px;
        }

        .backup-btn:hover {
            background: linear-gradient(135deg, #1E90FF 0%, #4169E1 100%);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(65, 105, 225, 0.3);
        }

        .backup-btn.import-btn {
            background: linear-gradient(135deg, #32CD32 0%, #228B22 100%);
            border-color: #006400;
        }

        .backup-btn.import-btn:hover {
            background: linear-gradient(135deg, #228B22 0%, #32CD32 100%);
        }

        .backup-input {
            display: none;
        }

        /* å‡çº§æç¤ºå¼¹çª— */
        .level-up-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border: 6px solid #8B4513;
            border-radius: 12px;
            padding: 30px 40px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
            z-index: 1001;
        }

        .level-up-title {
            font-size: 24px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 15px;
        }

        .level-up-desc {
            font-size: 18px;
            color: #654321;
            margin-bottom: 20px;
        }

        .level-up-btn {
            padding: 10px 25px;
            background: #8B4513;
            border: 2px solid #654321;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .level-up-btn:hover {
            background: #A0522D;
            transform: scale(1.05);
        }

        .answer-content {
            background: #F5F5DC;
            border: 8px solid #8B4513;
            border-radius: 12px;
            padding: 0;
            width: 100%;
            max-width: 500px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
        }

        /* ç­”é¢˜çª—å£æ ‡é¢˜æ  */
        .answer-titlebar {
            background: linear-gradient(135deg, #DAA520 0%, #FFD700 100%);
            padding: 12px 20px;
            border-radius: 4px 4px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .answer-titlebar:active {
            cursor: grabbing;
        }

        .answer-title {
            color: #FFF;
            font-size: 18px;
            font-weight: bold;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .answer-body {
            padding: 30px;
        }

        .question-title {
            font-size: 16px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 20px;
            text-align: left;
            line-height: 1.6;
        }

        .options-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 0;
        }

        .option-item {
            padding: 12px 15px;
            background: #FFF8DC;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .option-item:hover {
            background: #F0E68C;
            border-color: #DAA520;
        }

        .option-item.correct {
            background: #90EE90;
            border-color: #228B22;
        }

        .option-item.wrong {
            background: #FFB6C1;
            border-color: #CD5C5C;
        }



        /* æç¤ºæ¡† */
        .toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            padding: 12px 24px;
            background: rgba(139, 69, 19, 0.9);
            color: white;
            border: 2px solid #DAA520;
            border-radius: 8px;
            opacity: 0;
            transition: opacity 0.3s ease;
            z-index: 999;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .toast.show {
            opacity: 1;
        }

        /* èƒŒåŒ…æŒ‰é’®æ ·å¼ */
        .backpack-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);
            border: 3px solid #4B0082;
            border-radius: 8px;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            margin: 0 5px;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .backpack-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(147, 112, 219, 0.4);
            background: linear-gradient(135deg, #8A2BE2 0%, #9370DB 100%);
        }

        /* èƒŒåŒ…æµ®åŠ¨çª—å£ */
        .backpack-modal {
            display: none;
            position: fixed;
            top: 120px;
            right: 50px;
            z-index: 1001;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .backpack-modal.dragging {
            cursor: move;
            opacity: 0.9;
        }

        .backpack-content {
            background: linear-gradient(135deg, #F5F5DC 0%, #FFF8DC 100%);
            border: 8px solid #8B4513;
            border-radius: 15px;
            padding: 0;
            width: 700px;
            max-height: 80vh;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
        }

        .backpack-header {
            background: linear-gradient(135deg, #9370DB 0%, #8A2BE2 100%);
            padding: 12px 20px;
            border-radius: 7px 7px 0 0;
            cursor: move;
            display: flex;
            justify-content: space-between;
            align-items: center;
            user-select: none;
        }

        .backpack-header:active {
            cursor: grabbing;
        }

        .backpack-title {
            font-size: 18px;
            font-weight: bold;
            color: #FFF;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .backpack-body {
            padding: 25px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .backpack-close {
            padding: 6px 12px;
            background: rgba(255, 255, 255, 0.2);
            border: 2px solid rgba(255, 255, 255, 0.5);
            border-radius: 6px;
            color: white;
            cursor: pointer;
            transition: all 0.2s;
            font-weight: bold;
        }

        .backpack-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.05);
        }

        /* èƒŒåŒ…æ ‡ç­¾é¡µ */
        .backpack-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #D2B48C;
        }

        .backpack-tab {
            flex: 1;
            text-align: center;
            padding: 12px;
            cursor: pointer;
            font-weight: bold;
            color: #8B4513;
            background: #FFF8DC;
            border: 2px solid #D2B48C;
            border-bottom: none;
            border-radius: 8px 8px 0 0;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .backpack-tab:hover {
            background: #F0E68C;
        }

        .backpack-tab.active {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            color: white;
            border-color: #DAA520;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(218, 165, 32, 0.3);
        }

        /* èƒŒåŒ…å†…å®¹åŒº */
        .backpack-panel {
            display: none;
            min-height: 300px;
        }

        .backpack-panel.active {
            display: block;
        }

        /* èƒŒåŒ…ç‰©å“ç½‘æ ¼ */
        .backpack-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 15px;
            padding: 15px;
        }

        .backpack-item {
            background: #FFF8DC;
            border: 3px solid #D2B48C;
            border-radius: 10px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .backpack-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.15);
            border-color: #DAA520;
        }

        .backpack-item.selected {
            background: linear-gradient(135deg, #90EE90 0%, #32CD32 100%);
            border-color: #228B22;
            box-shadow: 0 6px 15px rgba(34, 139, 34, 0.4);
        }

        .backpack-item.selected::after {
            content: "âœ“";
            position: absolute;
            top: 5px;
            right: 5px;
            background: #228B22;
            color: white;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
        }

        .backpack-item-icon {
            font-size: 40px;
            margin-bottom: 8px;
        }

        .backpack-item-name {
            font-size: 16px;
            font-weight: bold;
            color: #8B4513;
            margin-bottom: 5px;
        }

        .backpack-item-info {
            font-size: 13px;
            color: #654321;
            line-height: 1.4;
        }

        .backpack-item-count {
            font-size: 14px;
            color: #DAA520;
            font-weight: bold;
            margin-top: 5px;
        }

        /* ç©ºèƒŒåŒ…æç¤º */
        .backpack-empty {
            text-align: center;
            padding: 60px 20px;
            color: #8B4513;
        }

        .backpack-empty-icon {
            font-size: 60px;
            margin-bottom: 15px;
            opacity: 0.5;
        }

        .backpack-empty-text {
            font-size: 18px;
            opacity: 0.7;
        }

        /* å³ä¾§æ’è¡Œæ¦œåŒºåŸŸ */
        .leaderboard-area {
            width: 280px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        /* æ’è¡Œæ¦œå®¹å™¨ */
        .leaderboard {
            background: linear-gradient(135deg, #FFF8DC 0%, #F5F5DC 100%);
            border: 4px solid #8B4513;
            border-radius: 12px;
            padding: 15px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .leaderboard-title {
            font-size: 18px;
            font-weight: bold;
            color: #8B4513;
            text-align: center;
            margin-bottom: 12px;
            padding-bottom: 10px;
            border-bottom: 2px solid #D2B48C;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .leaderboard-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
            max-height: 300px;
            overflow-y: auto;
        }

        /* æ’è¡Œæ¦œæ»šåŠ¨æ¡æ ·å¼ */
        .leaderboard-list::-webkit-scrollbar {
            width: 6px;
        }

        .leaderboard-list::-webkit-scrollbar-track {
            background: #F5F5DC;
            border-radius: 3px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb {
            background: #D2B48C;
            border-radius: 3px;
        }

        .leaderboard-list::-webkit-scrollbar-thumb:hover {
            background: #DAA520;
        }

        .leaderboard-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px;
            background: #FFF;
            border: 2px solid #D2B48C;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .leaderboard-item:hover {
            transform: translateX(3px);
            border-color: #DAA520;
            box-shadow: 0 2px 8px rgba(218, 165, 32, 0.2);
        }

        /* å‰ä¸‰åç‰¹æ®Šæ ·å¼ */
        .leaderboard-item.rank-1 {
            background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
            border-color: #DAA520;
        }

        .leaderboard-item.rank-2 {
            background: linear-gradient(135deg, #E8E8E8 0%, #C0C0C0 100%);
            border-color: #A9A9A9;
        }

        .leaderboard-item.rank-3 {
            background: linear-gradient(135deg, #F4A460 0%, #CD853F 100%);
            border-color: #8B4513;
        }

        .leaderboard-rank {
            font-size: 16px;
            font-weight: bold;
            color: #8B4513;
            min-width: 25px;
            text-align: center;
        }

        .rank-1 .leaderboard-rank,
        .rank-2 .leaderboard-rank,
        .rank-3 .leaderboard-rank {
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-avatar {
            font-size: 20px;
        }

        .leaderboard-info {
            flex: 1;
            min-width: 0;
        }

        .leaderboard-name {
            font-size: 14px;
            font-weight: bold;
            color: #8B4513;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .rank-1 .leaderboard-name,
        .rank-2 .leaderboard-name,
        .rank-3 .leaderboard-name {
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        .leaderboard-value {
            font-size: 13px;
            color: #654321;
            font-weight: bold;
        }

        .rank-1 .leaderboard-value,
        .rank-2 .leaderboard-value,
        .rank-3 .leaderboard-value {
            color: #FFF;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* ç©ºæ’è¡Œæ¦œæç¤º */
        .leaderboard-empty {
            text-align: center;
            padding: 30px 10px;
            color: #8B4513;
            opacity: 0.6;
            font-size: 14px;
        }

        /* æ’è¡Œæ¦œå ä½ç¬¦æ ·å¼ */
        .leaderboard-placeholder {
            opacity: 0.6;
            background: #F5F5DC !important;
            border-style: dashed !important;
        }

        .leaderboard-placeholder:hover {
            transform: none;
            box-shadow: none;
        }

        /* æ’è¡Œæ¦œåˆ·æ–°æç¤º */
        .leaderboard-hint {
            text-align: center;
            font-size: 11px;
            color: #8B4513;
            opacity: 0.5;
            margin-top: 8px;
            font-style: italic;
        }
    </style>
</head>

<body>
    <!-- ç™»å½•/æ³¨å†Œç•Œé¢ -->
    <div class="auth-container" id="authContainer">
        <div class="auth-welcome">ğŸŒ± æ¬¢è¿æ¥åˆ°å¼€å¿ƒå†œåœº ğŸŒ±</div>
        <div class="auth-tabs">
            <div class="auth-tab active" data-tab="login">ç™»å½•</div>
            <div class="auth-tab" data-tab="register">æ³¨å†Œ</div>
        </div>
        <form class="auth-form active" id="loginForm">
            <input type="text" id="loginUsername" placeholder="ç”¨æˆ·åï¼ˆ3-16ä½ï¼‰" required>
            <input type="password" id="loginPassword" placeholder="å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰" required>
            <label class="remember-password">
                <input type="checkbox" id="rememberPassword">
                <span>è®°ä½å¯†ç </span>
            </label>
            <button type="submit" class="auth-btn">å¼€å¯å†œåœºä¹‹æ—…</button>
        </form>
        <form class="auth-form" id="registerForm">
            <input type="text" id="registerUsername" placeholder="ç”¨æˆ·åï¼ˆ3-16ä½ï¼‰" required>
            <input type="password" id="registerPassword" placeholder="å¯†ç ï¼ˆ6ä½ä»¥ä¸Šï¼‰" required>
            <button type="submit" class="auth-btn">æ³¨å†Œå†œåœºè´¦å·</button>
        </form>
        
        <!-- å¯¼å…¥å­˜æ¡£æŒ‰é’® -->
        <button class="import-save-btn" id="importSaveBtn">
            <span>ğŸ“¤</span>
            <span>å¯¼å…¥å­˜æ¡£</span>
        </button>
        <input type="file" class="backup-input" id="loginImportInput" accept=".json">
    </div>

    <!-- æ¸¸æˆç•Œé¢ -->
    <div class="game-container" id="gameContainer">
        <div class="game-header">
            <div>
                <!-- ç”¨æˆ·ä¿¡æ¯ï¼ˆå¤´åƒ+ç”¨æˆ·åï¼‰ -->
                <div class="user-info" id="userInfo">
                    <div class="user-avatar" id="userAvatar">ğŸŒ±</div>
                    <div>
                        <div class="user-name" id="userName">ç”¨æˆ·å</div>
                        <div class="user-level" id="userLevel">Lv.1 | ç»éªŒ: 0/100</div>
                    </div>
                </div>
                <div class="gold-display">ğŸ’° å†œåœºé‡‘å¸: <span id="gold">0</span></div>
            </div>
            <div>
                <div class="time-display">â±ï¸ <span id="currentTime">2026-02-13 12:00:00</span><br>
                    ğŸ“ <span id="location">è·å–ä½ç½®ä¸­...</span> | ğŸ“… <span id="solarTerm">ç«‹æ˜¥</span> | â˜ï¸ <span
                        id="weather">è·å–å¤©æ°”ä¸­...</span></div>
                <div class="header-actions">
                    <span class="auto-save-indicator" id="autoSaveIndicator">ğŸ’¾ è‡ªåŠ¨å­˜æ¡£å¼€å¯</span>
                    <button class="export-save-btn" id="exportSaveBtn">
                        <span>ğŸ“¥</span>
                        <span>å¯¼å‡ºå­˜æ¡£</span>
                    </button>
                    <button class="logout-btn" id="logoutBtn">é€€å‡ºå†œåœº</button>
                </div>
            </div>
        </div>

        <!-- æ¸¸æˆä¸»ä½“åŒºåŸŸ -->
        <div class="game-main">
            <!-- å·¦ä¾§å†œåœºåŒºåŸŸ -->
            <div class="farm-area">
                <div class="farm-container" id="farm"></div>

                <!-- åŠŸèƒ½æŒ‰é’®åŒº -->
                <div class="reclaim-section">
                    <button class="backpack-btn" id="backpackBtn">ğŸ’ æ‰“å¼€èƒŒåŒ…</button>
                    <button class="reclaim-btn" id="reclaimBtn">å¼€å¦æ–°åœ°å— (50é‡‘å¸)</button>
                    <button class="remove-plot-btn" id="removePlotBtn">ğŸ—‘ï¸ é“²é™¤åœ°å— (å›æ”¶50é‡‘å¸)</button>
                    <button class="harvest-all-btn" id="harvestAllBtn">ğŸšœ ä¸€é”®æ”¶è·æ‰€æœ‰æˆç†Ÿä½œç‰©</button>
                    <button class="answer-btn" id="answerBtn">ğŸ“ ç­”é¢˜èµšé‡‘å¸ (ç­”å¯¹å¾—100é‡‘å¸)</button>
                </div>
            </div>

            <!-- å³ä¾§æ’è¡Œæ¦œåŒºåŸŸ -->
            <div class="leaderboard-area">
                <!-- ç­‰çº§æ’è¡Œæ¦œ -->
                <div class="leaderboard">
                    <div class="leaderboard-title">ğŸ† ç­‰çº§æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-list" id="levelLeaderboard">
                        <!-- åŠ¨æ€ç”Ÿæˆæ’è¡Œæ¦œå†…å®¹ -->
                    </div>
                    <div class="leaderboard-hint">* åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°æ’å</div>
                </div>

                <!-- é‡‘å¸æ’è¡Œæ¦œ -->
                <div class="leaderboard">
                    <div class="leaderboard-title">ğŸ’° é‡‘å¸æ’è¡Œæ¦œ</div>
                    <div class="leaderboard-list" id="goldLeaderboard">
                        <!-- åŠ¨æ€ç”Ÿæˆæ’è¡Œæ¦œå†…å®¹ -->
                    </div>
                    <div class="leaderboard-hint">* åˆ·æ–°é¡µé¢æŸ¥çœ‹æœ€æ–°æ’å</div>
                </div>
            </div>
        </div>
    </div>

    <!-- ç­”é¢˜æµ®åŠ¨çª—å£ -->
    <div class="answer-modal" id="answerModal">
        <div class="answer-content">
            <!-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
            <div class="answer-titlebar" id="answerTitlebar">
                <div class="answer-title">ğŸ“ ç­”é¢˜èµšé‡‘å¸</div>
                <button class="backpack-close" id="closeAnswerModal">âœ•</button>
            </div>

            <!-- çª—å£å†…å®¹ -->
            <div class="answer-body">
                <div class="question-title" id="questionTitle">é—®é¢˜åŠ è½½ä¸­...</div>
                <div class="options-list" id="optionsList"></div>
            </div>
        </div>
    </div>

    <!-- ä¸ªäººä¿¡æ¯æµ®åŠ¨çª—å£ -->
    <div class="user-modal" id="userModal">
        <div class="user-modal-content">
            <!-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
            <div class="modal-titlebar" id="userModalTitlebar">
                <div class="modal-title">ğŸ‘¤ ä¸ªäººä¿¡æ¯</div>
                <button class="backpack-close" id="closeUserModal">âœ•</button>
            </div>

            <!-- çª—å£å†…å®¹ -->
            <div class="modal-body">
                <div class="user-modal-header">
                    <div class="user-modal-avatar" id="modalUserAvatar">ğŸŒ±</div>
                    <div class="user-modal-info">
                        <div class="user-modal-name" id="modalUserName">ç”¨æˆ·å</div>
                        <div class="user-modal-level" id="modalUserLevel">Lv.1</div>
                    </div>
                </div>

                <div>
                    <div><strong>è´¦å·ï¼š</strong><span id="modalUserAccount">è´¦å·</span></div>
                    <div><strong>é‡‘å¸ï¼š</strong><span id="modalUserGold">0</span></div>
                    <div class="exp-text">ç»éªŒï¼š<span id="modalUserExp">0</span>/<span id="modalUserExpNeed">100</span>
                    </div>
                    <div class="exp-bar-container">
                        <div class="exp-bar" id="expBar" style="width: 0%"></div>
                    </div>
                </div>

                <div class="warehouse-title">ğŸ“¦ æˆ‘çš„æ”¶è·</div>
                <div class="warehouse-list" id="warehouseList">
                    <!-- ä»“åº“ä½œç‰©åŠ¨æ€ç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <!-- å‡çº§æç¤ºå¼¹çª— -->
    <div class="level-up-modal" id="levelUpModal">
        <div class="level-up-title">ğŸ‰ æ­å–œå‡çº§!</div>
        <div class="level-up-desc" id="levelUpDesc">ä½ å·²å‡çº§åˆ° Lv.2,ç»§ç»­åŠ æ²¹!</div>
        <button class="level-up-btn" id="levelUpBtn">ç¡®å®š</button>
    </div>

    <!-- èƒŒåŒ…æµ®åŠ¨çª—å£ -->
    <div class="backpack-modal" id="backpackModal">
        <div class="backpack-content">
            <!-- æ ‡é¢˜æ ï¼ˆå¯æ‹–åŠ¨ï¼‰ -->
            <div class="backpack-header" id="backpackHeader">
                <div class="backpack-title">ğŸ’ æˆ‘çš„èƒŒåŒ…</div>
                <button class="backpack-close" id="closeBackpack">âœ•</button>
            </div>

            <!-- çª—å£å†…å®¹ -->
            <div class="backpack-body">
                <!-- èƒŒåŒ…æ ‡ç­¾é¡µ -->
                <div class="backpack-tabs">
                    <div class="backpack-tab active" data-tab="crops">ğŸŒ¾ ä½œç‰©</div>
                    <div class="backpack-tab" data-tab="seeds">ğŸŒ± ç§å­</div>
                    <div class="backpack-tab" data-tab="tools">ğŸ”§ é“å…·</div>
                </div>

                <!-- ä½œç‰©é¢æ¿ -->
                <div class="backpack-panel active" id="cropsPanel">
                    <div class="backpack-grid" id="cropsGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆä½œç‰©åˆ—è¡¨ -->
                    </div>
                </div>

                <!-- ç§å­é¢æ¿ -->
                <div class="backpack-panel" id="seedsPanel">
                    <div class="backpack-grid" id="seedsGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆç§å­åˆ—è¡¨ -->
                    </div>
                </div>

                <!-- é“å…·é¢æ¿ -->
                <div class="backpack-panel" id="toolsPanel">
                    <div class="backpack-grid" id="toolsGrid">
                        <!-- åŠ¨æ€ç”Ÿæˆé“å…·åˆ—è¡¨ -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="toast" id="toast"></div>

    <script>
        // ========== å…¨å±€çŠ¶æ€ ==========
        const MAX_PLOTS = 30; // æœ€å¤§åœ°å—æ•°é‡ï¼ˆ5x6å¸ƒå±€ï¼‰
        const INITIAL_PLOTS = 5; // åˆå§‹åœ°å—æ•°é‡
        let currentUser = null;
        let selectedSeed = null;
        let selectedProp = null; // é€‰ä¸­çš„é“å…·
        let gameLoopInterval = null;
        let currentQuestion = null; // å½“å‰ç­”é¢˜é¢˜ç›®
        let userLocation = { lat: null, lon: null, name: "æœªçŸ¥ä½ç½®" }; // ç”¨æˆ·ä½ç½®ä¿¡æ¯
        
        // è‡ªåŠ¨å­˜æ¡£ç›¸å…³å˜é‡
        let autoSaveFileHandle = null; // File System Access API æ–‡ä»¶å¥æŸ„
        let autoSaveInterval = null; // è‡ªåŠ¨å­˜æ¡£å®šæ—¶å™¨

        // ä½œç‰©è‹±æ–‡è½¬ä¸­æ–‡æ˜ å°„ + å›¾æ ‡
        const seedConfig = {
            carrot: { name: 'èƒ¡èåœ', emoji: 'ğŸ¥•', price: 10, gain: 20, mature: 10, exp: 10 },
            wheat: { name: 'å°éº¦', emoji: 'ğŸŒ¾', price: 20, gain: 40, mature: 20, exp: 20 },
            tomato: { name: 'ç•ªèŒ„', emoji: 'ğŸ…', price: 30, gain: 60, mature: 30, exp: 30 }
        };

        // é»˜è®¤å¤´åƒåˆ—è¡¨
        const defaultAvatars = ['ğŸŒ±', 'ğŸ®', 'ğŸ”', 'ğŸ‘', 'ğŸŒ»', 'ğŸ€', 'ğŸ¥•', 'ğŸŒ¾'];

        // 24èŠ‚æ°”ï¼ˆæŒ‰å†œå†æœˆä»½æ’åºï¼‰
        const solarTerms = [
            "å°å¯’", "å¤§å¯’", "ç«‹æ˜¥", "é›¨æ°´", "æƒŠè›°", "æ˜¥åˆ†",
            "æ¸…æ˜", "è°·é›¨", "ç«‹å¤", "å°æ»¡", "èŠ’ç§", "å¤è‡³",
            "å°æš‘", "å¤§æš‘", "ç«‹ç§‹", "å¤„æš‘", "ç™½éœ²", "ç§‹åˆ†",
            "å¯’éœ²", "éœœé™", "ç«‹å†¬", "å°é›ª", "å¤§é›ª", "å†¬è‡³"
        ];

        // å¸¸è¯†é¢˜åº“
        const questionBank = [
            {
                question: 'ä¸­å›½çš„é¦–éƒ½æ˜¯å“ªé‡Œï¼Ÿ',
                options: ['ä¸Šæµ·', 'åŒ—äº¬', 'å¹¿å·', 'æ·±åœ³'],
                answer: 1
            },
            {
                question: 'ä¸€å¹´æœ‰å¤šå°‘ä¸ªå­£èŠ‚ï¼Ÿ',
                options: ['2ä¸ª', '3ä¸ª', '4ä¸ª', '6ä¸ª'],
                answer: 2
            },
            {
                question: 'æ°´çš„åŒ–å­¦å¼æ˜¯ï¼Ÿ',
                options: ['H2O', 'CO2', 'O2', 'H2'],
                answer: 0
            },
            {
                question: 'åœ°çƒç»•ç€ä»€ä¹ˆè½¬ï¼Ÿ',
                options: ['æœˆäº®', 'å¤ªé˜³', 'ç«æ˜Ÿ', 'é‡‘æ˜Ÿ'],
                answer: 1
            },
            {
                question: 'ä¸€å‘¨æœ‰å‡ å¤©ï¼Ÿ',
                options: ['5å¤©', '6å¤©', '7å¤©', '8å¤©'],
                answer: 2
            }
        ];

        // ========== å·¥å…·å‡½æ•° ==========
        // è·å–å½“å‰åŒ—äº¬æ—¶é—´ï¼ˆæ ¼å¼åŒ–ï¼šYYYY-MM-DD HH:mm:ssï¼‰
        function getCurrentBeijingTime() {
            const now = new Date();
            const year = now.getFullYear();
            const month = String(now.getMonth() + 1).padStart(2, '0');
            const day = String(now.getDate()).padStart(2, '0');
            const hour = String(now.getHours()).padStart(2, '0');
            const minute = String(now.getMinutes()).padStart(2, '0');
            const second = String(now.getSeconds()).padStart(2, '0');
            return `${year}-${month}-${day} ${hour}:${minute}:${second}`;
        }

        // è®¡ç®—å½“å‰èŠ‚æ°”ï¼ˆç®€åŒ–ç‰ˆï¼ŒæŒ‰æœˆä»½+æ—¥æœŸä¼°ç®—ï¼‰
        function getCurrentSolarTerm() {
            const now = new Date();
            const month = now.getMonth(); // 0-11
            const day = now.getDate();

            // ç®€åŒ–ç‰ˆèŠ‚æ°”è®¡ç®—ï¼ˆå®é™…éœ€ç»“åˆå†œå†ï¼Œè¿™é‡ŒæŒ‰å…¬å†ä¼°ç®—ï¼‰
            const termIndex = Math.floor((month * 30 + day) / 15) % 24;
            return solarTerms[termIndex];
        }

        // è·å–ç”¨æˆ·åœ°ç†ä½ç½®ï¼ˆç»çº¬åº¦+åç§°ï¼‰
        async function getUserLocation() {
            return new Promise((resolve) => {
                if (!navigator.geolocation) {
                    showToast('ä½ çš„æµè§ˆå™¨ä¸æ”¯æŒåœ°ç†ä½ç½®è·å–');
                    resolve(false);
                    return;
                }

                navigator.geolocation.getCurrentPosition(
                    async (position) => {
                        const { latitude, longitude } = position.coords;
                        userLocation.lat = latitude;
                        userLocation.lon = longitude;

                        // é€†åœ°ç†ç¼–ç è·å–ä½ç½®åç§°ï¼ˆä½¿ç”¨OpenStreetMapå…è´¹æ¥å£ï¼‰
                        try {
                            const res = await fetch(`https://nominatim.openstreetmap.org/reverse?lat=${latitude}&lon=${longitude}&format=json&language=zh-CN`);
                            const data = await res.json();
                            if (data.address) {
                                const city = data.address.city || data.address.town || data.address.village || "æœªçŸ¥åŒºåŸŸ";
                                const province = data.address.state || data.address.province || "";
                                userLocation.name = `${province}${city}`;
                            }
                        } catch (e) {
                            userLocation.name = "æœªçŸ¥ä½ç½®";
                        }
                        resolve(true);
                    },
                    (error) => {
                        showToast('ä½ç½®è·å–å¤±è´¥ï¼Œå°†æ˜¾ç¤ºé»˜è®¤å¤©æ°”');
                        resolve(false);
                    },
                    { timeout: 10000, enableHighAccuracy: false }
                );
            });
        }

        // è·å–ç”¨æˆ·ä½ç½®çš„çœŸå®å¤©æ°”ï¼ˆä½¿ç”¨Open-Meteoå…è´¹APIï¼Œæ— è·¨åŸŸé—®é¢˜ï¼‰
        async function getRealWeather() {
            if (!userLocation.lat || !userLocation.lon) {
                return "æœªçŸ¥å¤©æ°”";
            }

            try {
                // è°ƒç”¨å®æ—¶å¤©æ°”API
                const res = await fetch(`https://api.open-meteo.com/v1/forecast?latitude=${userLocation.lat}&longitude=${userLocation.lon}&current_weather=true&language=zh`);
                const data = await res.json();

                if (data.current_weather) {
                    const weatherCode = data.current_weather.weathercode;
                    // å¤©æ°”ç¼–ç æ˜ å°„ï¼ˆå‚è€ƒOpen-Meteoæ–‡æ¡£ï¼‰
                    const weatherMap = {
                        0: "æ™´",
                        1: "å¤šäº‘",
                        2: "å°‘äº‘",
                        3: "é˜´",
                        45: "é›¾",
                        48: "éœ¾",
                        51: "å°é›¨",
                        53: "ä¸­é›¨",
                        55: "å¤§é›¨",
                        61: "é™é›¨",
                        63: "æš´é›¨",
                        65: "å¤§æš´é›¨",
                        71: "å°é›ª",
                        73: "ä¸­é›ª",
                        75: "å¤§é›ª",
                        95: "é›·é˜µé›¨",
                        96: "é›·é˜µé›¨ä¼´å†°é›¹",
                        99: "æš´é›¨ä¼´å†°é›¹"
                    };
                    return weatherMap[weatherCode] || `æœªçŸ¥(${weatherCode})`;
                }
            } catch (e) {
                console.error("å¤©æ°”è·å–å¤±è´¥:", e);
            }
            return "æœªçŸ¥å¤©æ°”";
        }

        // æ›´æ–°æ—¶é—´/èŠ‚æ°”/å¤©æ°”/ä½ç½®æ˜¾ç¤º
        async function updateTimeDisplay() {
            // æ›´æ–°æ—¶é—´å’ŒèŠ‚æ°”
            document.getElementById('currentTime').textContent = getCurrentBeijingTime();
            document.getElementById('solarTerm').textContent = getCurrentSolarTerm();
            // æ›´æ–°ä½ç½®
            document.getElementById('location').textContent = userLocation.name;
            // æ›´æ–°çœŸå®å¤©æ°”
            const weather = await getRealWeather();
            document.getElementById('weather').textContent = weather;
        }

        // è®¡ç®—å‡çº§æ‰€éœ€ç»éªŒï¼ˆlv1:100, lv2:200, lv3:400, lv4:800... ç¿»å€ï¼‰
        function getExpNeed(level) {
            return 100 * Math.pow(2, level - 1);
        }

        // æ ¼å¼åŒ–æ—¶é—´ï¼ˆç§’æ•°è½¬æ¢ä¸ºXåˆ†Xç§’ï¼‰
        function formatTime(seconds) {
            if (seconds <= 0) {
                return 'å¯æ”¶è·';
            }
            const minutes = Math.floor(seconds / 60);
            const secs = seconds % 60;
            if (minutes > 0) {
                return `${minutes}åˆ†${secs}ç§’`;
            } else {
                return `${secs}ç§’`;
            }
        }

        // æ£€æŸ¥æ˜¯å¦å‡çº§
        function checkLevelUp() {
            const expNeed = getExpNeed(currentUser.level);
            if (currentUser.exp >= expNeed) {
                // å‡çº§
                currentUser.level += 1;
                currentUser.exp -= expNeed; // å‰©ä½™ç»éªŒä¿ç•™
                saveUserProgress();

                // æ˜¾ç¤ºå‡çº§å¼¹çª—
                document.getElementById('levelUpDesc').textContent = `ä½ å·²å‡çº§åˆ° Lv.${currentUser.level}ï¼Œç»§ç»­åŠ æ²¹ï¼`;
                document.getElementById('levelUpModal').style.display = 'block';

                // æ›´æ–°UI
                updateUserInfoUI();
                updateUserModalUI();
                showToast(`æ­å–œå‡çº§åˆ° Lv.${currentUser.level}ï¼`);
            }
        }

        // å–å‡ºä½œç‰©
        function sellCrop(cropType) {
            if (currentUser.warehouse[cropType] <= 0) {
                showToast(`ä½ çš„ä»“åº“é‡Œæ²¡æœ‰${seedConfig[cropType].name}ï¼`);
                return;
            }

            // å–å‡ºå…¨éƒ¨è¯¥ä½œç‰©
            const count = currentUser.warehouse[cropType];
            const gain = count * seedConfig[cropType].gain;

            currentUser.gold += gain;
            currentUser.warehouse[cropType] = 0;

            saveUserProgress();
            updateUI();
            updateUserModalUI();
            showToast(`æˆåŠŸå–å‡º ${count} ä¸ª${seedConfig[cropType].name}ï¼Œè·å¾— ${gain} é‡‘å¸ï¼`);
        }

        // å–å‡ºæŒ‡å®šæ•°é‡çš„ä½œç‰©
        function sellCropQuantity(cropType, quantity) {
            if (currentUser.warehouse[cropType] <= 0) {
                showToast(`ä½ çš„ä»“åº“é‡Œæ²¡æœ‰${seedConfig[cropType].name}ï¼`);
                return;
            }

            if (quantity > currentUser.warehouse[cropType]) {
                showToast(`ä»“åº“é‡Œåªæœ‰ ${currentUser.warehouse[cropType]} ä¸ª${seedConfig[cropType].name}ï¼`);
                return;
            }

            // å–å‡ºæŒ‡å®šæ•°é‡çš„ä½œç‰©
            const gain = quantity * seedConfig[cropType].gain;

            currentUser.gold += gain;
            currentUser.warehouse[cropType] -= quantity;

            saveUserProgress();
            updateUI();
            updateUserModalUI();
            showToast(`æˆåŠŸå–å‡º ${quantity} ä¸ª${seedConfig[cropType].name}ï¼Œè·å¾— ${gain} é‡‘å¸ï¼`);
        }

        // ========== æ’è¡Œæ¦œåŠŸèƒ½ ==========
        // è·å–æ‰€æœ‰ç”¨æˆ·æ•°æ®
        function getAllUsers() {
            const users = [];
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('user_')) {
                    try {
                        const userData = JSON.parse(localStorage.getItem(key));
                        if (userData && userData.username) {
                            users.push(userData);
                        }
                    } catch (e) {
                        console.error('è§£æç”¨æˆ·æ•°æ®å¤±è´¥:', key, e);
                    }
                }
            }
            return users;
        }

        // æ¸²æŸ“ç­‰çº§æ’è¡Œæ¦œ
        function renderLevelLeaderboard() {
            const users = getAllUsers();
            const levelLeaderboard = document.getElementById('levelLeaderboard');
            const TOP_COUNT = 5; // å›ºå®šæ˜¾ç¤ºå‰5å

            // æŒ‰ç­‰çº§å’Œç»éªŒæ’åºï¼ˆç¡®ä¿æ­£ç¡®å¤„ç†é»˜è®¤å€¼ï¼‰
            users.sort((a, b) => {
                const levelA = a.level || 1;
                const levelB = b.level || 1;
                if (levelB !== levelA) {
                    return levelB - levelA;
                }
                return (b.exp || 0) - (a.exp || 0);
            });

            // è·å–å‰5åç”¨æˆ·
            const top5 = users.slice(0, TOP_COUNT);

            // ç”Ÿæˆæ’è¡Œæ¦œHTML
            const leaderboardHTML = [];
            for (let i = 0; i < TOP_COUNT; i++) {
                const rank = i + 1;
                const user = top5[i];

                if (user) {
                    // æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ­£å¸¸æ˜¾ç¤º
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const isCurrentUser = currentUser && user.username === currentUser.username;
                    const highlightStyle = isCurrentUser ? 'style="border: 3px solid #32CD32;"' : '';

                    leaderboardHTML.push(`
                        <div class="leaderboard-item ${rankClass}" ${highlightStyle}>
                            <div class="leaderboard-rank">${rank}</div>
                            <div class="leaderboard-avatar">${user.avatar || 'ğŸŒ±'}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${user.username}${isCurrentUser ? ' (æˆ‘)' : ''}</div>
                                <div class="leaderboard-value">Lv.${user.level || 1} | ç»éªŒ: ${user.exp || 0}</div>
                            </div>
                        </div>
                    `);
                } else {
                    // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                    leaderboardHTML.push(`
                        <div class="leaderboard-item leaderboard-placeholder">
                            <div class="leaderboard-rank">${rank}</div>
                            <div class="leaderboard-avatar">ğŸ‘»</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name" style="opacity: 0.5;">æš‚æ— äººä¸Šæ¦œ</div>
                                <div class="leaderboard-value" style="opacity: 0.5;">-</div>
                            </div>
                        </div>
                    `);
                }
            }

            levelLeaderboard.innerHTML = leaderboardHTML.join('');
        }

        // æ¸²æŸ“é‡‘å¸æ’è¡Œæ¦œ
        function renderGoldLeaderboard() {
            const users = getAllUsers();
            const goldLeaderboard = document.getElementById('goldLeaderboard');
            const TOP_COUNT = 5; // å›ºå®šæ˜¾ç¤ºå‰5å

            // æŒ‰é‡‘å¸æ’åº
            users.sort((a, b) => (b.gold || 0) - (a.gold || 0));

            // è·å–å‰5åç”¨æˆ·
            const top5 = users.slice(0, TOP_COUNT);

            // ç”Ÿæˆæ’è¡Œæ¦œHTML
            const leaderboardHTML = [];
            for (let i = 0; i < TOP_COUNT; i++) {
                const rank = i + 1;
                const user = top5[i];

                if (user) {
                    // æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ­£å¸¸æ˜¾ç¤º
                    const rankClass = rank <= 3 ? `rank-${rank}` : '';
                    const isCurrentUser = currentUser && user.username === currentUser.username;
                    const highlightStyle = isCurrentUser ? 'style="border: 3px solid #32CD32;"' : '';

                    leaderboardHTML.push(`
                        <div class="leaderboard-item ${rankClass}" ${highlightStyle}>
                            <div class="leaderboard-rank">${rank}</div>
                            <div class="leaderboard-avatar">${user.avatar || 'ğŸŒ±'}</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name">${user.username}${isCurrentUser ? ' (æˆ‘)' : ''}</div>
                                <div class="leaderboard-value">ğŸ’° ${user.gold || 0}</div>
                            </div>
                        </div>
                    `);
                } else {
                    // æ²¡æœ‰ç”¨æˆ·æ•°æ®ï¼Œæ˜¾ç¤ºå ä½ç¬¦
                    leaderboardHTML.push(`
                        <div class="leaderboard-item leaderboard-placeholder">
                            <div class="leaderboard-rank">${rank}</div>
                            <div class="leaderboard-avatar">ğŸ‘»</div>
                            <div class="leaderboard-info">
                                <div class="leaderboard-name" style="opacity: 0.5;">æš‚æ— äººä¸Šæ¦œ</div>
                                <div class="leaderboard-value" style="opacity: 0.5;">-</div>
                            </div>
                        </div>
                    `);
                }
            }

            goldLeaderboard.innerHTML = leaderboardHTML.join('');
        }

        // æ›´æ–°æ’è¡Œæ¦œ
        function updateLeaderboards() {
            renderLevelLeaderboard();
            renderGoldLeaderboard();
        }

        // ========== çª—å£æ‹–åŠ¨åŠŸèƒ½ ==========
        function initDraggable(modalId, titlebarId) {
            const modal = document.getElementById(modalId);
            const titlebar = document.getElementById(titlebarId);

            if (!modal || !titlebar) return;

            let isDragging = false;
            let currentX;
            let currentY;
            let initialX;
            let initialY;
            let xOffset = 0;
            let yOffset = 0;

            titlebar.addEventListener('mousedown', dragStart);
            document.addEventListener('mousemove', drag);
            document.addEventListener('mouseup', dragEnd);

            function dragStart(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯å…³é—­æŒ‰é’®ï¼Œä¸è§¦å‘æ‹–åŠ¨
                if (e.target.classList.contains('backpack-close')) {
                    return;
                }

                initialX = e.clientX - xOffset;
                initialY = e.clientY - yOffset;

                if (e.target === titlebar || titlebar.contains(e.target)) {
                    isDragging = true;
                    modal.classList.add('dragging');
                }
            }

            function drag(e) {
                if (isDragging) {
                    e.preventDefault();

                    currentX = e.clientX - initialX;
                    currentY = e.clientY - initialY;

                    xOffset = currentX;
                    yOffset = currentY;

                    setTranslate(currentX, currentY, modal);
                }
            }

            function dragEnd(e) {
                initialX = currentX;
                initialY = currentY;

                isDragging = false;
                modal.classList.remove('dragging');
            }

            function setTranslate(xPos, yPos, el) {
                el.style.transform = `translate(${xPos}px, ${yPos}px)`;
            }
        }

        // ========== åˆå§‹åŒ– ==========
        async function init() {
            // å…ˆè·å–ç”¨æˆ·ä½ç½®
            await getUserLocation();

            // è‡ªåŠ¨ç™»å½•æ£€æŸ¥
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                const userData = JSON.parse(localStorage.getItem(`user_${savedUser}`));
                if (userData) {
                    currentUser = userData;
                    // å…¼å®¹æ—§æ•°æ®
                    if (!currentUser.avatar) currentUser.avatar = defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];
                    if (!currentUser.level) currentUser.level = 1;
                    if (!currentUser.exp) currentUser.exp = 0;
                    if (!currentUser.warehouse) currentUser.warehouse = { carrot: 0, wheat: 0, tomato: 0 };

                    // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰30å—åœŸåœ°ï¼Œè¡¥é½åˆ°30å—
                    if (currentUser.plots.length < MAX_PLOTS) {
                        const currentLength = currentUser.plots.length;
                        for (let i = currentLength; i < MAX_PLOTS; i++) {
                            currentUser.plots.push({
                                seed: null,
                                matureAt: 0,
                                gain: 0,
                                exp: 0,
                                unlocked: false
                            });
                        }
                    }

                    // ç¡®ä¿æ‰€æœ‰åœŸåœ°éƒ½æœ‰unlockedå­—æ®µ
                    currentUser.plots.forEach((plot, idx) => {
                        if (plot.unlocked === undefined) {
                            plot.unlocked = idx < INITIAL_PLOTS;
                        }
                    });
                    showGame();
                    startGameLoop();
                } else {
                    localStorage.removeItem('currentUser');
                }
            }

            // åŠ è½½è®°ä½çš„å¯†ç 
            const rememberedUser = localStorage.getItem('rememberedUser');
            const rememberedPassword = localStorage.getItem('rememberedPassword');
            if (rememberedUser && rememberedPassword) {
                document.getElementById('loginUsername').value = rememberedUser;
                document.getElementById('loginPassword').value = rememberedPassword;
                document.getElementById('rememberPassword').checked = true;
            }

            // ç™»å½•/æ³¨å†Œæ ‡ç­¾åˆ‡æ¢
            document.querySelectorAll('.auth-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                    document.getElementById(`${tab.dataset.tab}Form`).classList.add('active');
                });
            });

            // ç™»å½•/æ³¨å†Œæäº¤
            document.getElementById('loginForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('loginUsername').value.trim();
                const password = document.getElementById('loginPassword').value;
                const rememberMe = document.getElementById('rememberPassword').checked;
                login(username, password, rememberMe);
            });
            document.getElementById('registerForm').addEventListener('submit', (e) => {
                e.preventDefault();
                const username = document.getElementById('registerUsername').value.trim();
                const password = document.getElementById('registerPassword').value;
                register(username, password);
            });

            // é€€å‡ºç™»å½•
            document.getElementById('logoutBtn').addEventListener('click', logout);

            // å¼€å¦åœ°å—ç»‘å®š
            document.getElementById('reclaimBtn').addEventListener('click', reclaimPlot);

            // é“²é™¤åœ°å—ç»‘å®š
            document.getElementById('removePlotBtn').addEventListener('click', removePlot);

            // ä¸€é”®æ”¶è·ç»‘å®š
            document.getElementById('harvestAllBtn').addEventListener('click', harvestAll);

            // ç­”é¢˜æŒ‰é’®ç»‘å®š
            document.getElementById('answerBtn').addEventListener('click', openAnswerModal);
            document.getElementById('closeAnswerModal').addEventListener('click', closeAnswerModal);

            // ä¸ªäººä¿¡æ¯å¼¹çª—ç»‘å®š
            document.getElementById('userInfo').addEventListener('click', openUserModal);
            document.getElementById('closeUserModal').addEventListener('click', closeUserModal);

            // å‡çº§å¼¹çª—æŒ‰é’®ç»‘å®š
            document.getElementById('levelUpBtn').addEventListener('click', () => {
                document.getElementById('levelUpModal').style.display = 'none';
            });

            // èƒŒåŒ…æŒ‰é’®ç»‘å®š
            document.getElementById('backpackBtn').addEventListener('click', openBackpack);
            document.getElementById('closeBackpack').addEventListener('click', closeBackpack);

            // èƒŒåŒ…æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.backpack-tab').forEach(tab => {
                tab.addEventListener('click', () => {
                    document.querySelectorAll('.backpack-tab').forEach(t => t.classList.remove('active'));
                    tab.classList.add('active');
                    document.querySelectorAll('.backpack-panel').forEach(p => p.classList.remove('active'));
                    const panelId = tab.dataset.tab + 'Panel';
                    document.getElementById(panelId).classList.add('active');
                });
            });

            // å¯¼å‡ºå­˜æ¡£ç»‘å®šï¼ˆæ¸¸æˆå¤´éƒ¨ï¼‰
            document.getElementById('exportSaveBtn').addEventListener('click', exportSaveData);
            
            // å¯¼å…¥å­˜æ¡£ç»‘å®šï¼ˆç™»å½•é¡µï¼‰
            document.getElementById('importSaveBtn').addEventListener('click', () => {
                document.getElementById('loginImportInput').click();
            });
            document.getElementById('loginImportInput').addEventListener('change', importSaveData);

            // åˆå§‹åŒ–ç­”é¢˜å¼¹çª—ç‚¹å‡»äº‹ä»¶
            document.getElementById('optionsList').addEventListener('click', handleAnswerSelect);

            // åˆå§‹åŒ–æ‹–åŠ¨åŠŸèƒ½
            initDraggable('userModal', 'userModalTitlebar');
            initDraggable('backpackModal', 'backpackHeader');
            initDraggable('answerModal', 'answerTitlebar');

            // åˆå§‹åŒ–æ—¶é—´æ˜¾ç¤º
            updateTimeDisplay();
            // æ¯ç§’æ›´æ–°æ—¶é—´ï¼Œæ¯åˆ†é’Ÿæ›´æ–°ä¸€æ¬¡å¤©æ°”ï¼ˆé¿å…é¢‘ç¹è¯·æ±‚ï¼‰
            setInterval(updateTimeDisplay, 1000);
            setInterval(async () => {
                const weather = await getRealWeather();
                document.getElementById('weather').textContent = weather;
            }, 60000);
        }

        // ========== è´¦å·ç³»ç»Ÿ ==========
        function register(username, password) {
            if (username.length < 3 || username.length > 16) {
                showToast('ç”¨æˆ·åé•¿åº¦éœ€åœ¨3-16ä½ä¹‹é—´');
                return;
            }
            if (password.length < 6) {
                showToast('å¯†ç é•¿åº¦éœ€åœ¨6ä½ä»¥ä¸Š');
                return;
            }
            if (localStorage.getItem(`user_${username}`)) {
                showToast('ç”¨æˆ·åå·²å­˜åœ¨');
                return;
            }

            // åˆå§‹åŒ–ç”¨æˆ·æ•°æ®
            const userData = {
                username,
                password,
                avatar: defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)], // éšæœºé»˜è®¤å¤´åƒ
                level: 1, // åˆå§‹ç­‰çº§
                exp: 0, // åˆå§‹ç»éªŒ
                gold: 100,
                gameTime: 0,
                plots: [],
                warehouse: { // ä»“åº“ï¼Œå­˜å‚¨æ”¶è·çš„ä½œç‰©
                    carrot: 0,
                    wheat: 0,
                    tomato: 0
                }
            };

            // åˆå§‹åŒ–30å—åœŸåœ°ï¼šå‰5å—å·²å¼€å¦ï¼Œå25å—å¾…å¼€å¦
            for (let i = 0; i < MAX_PLOTS; i++) {
                if (i < INITIAL_PLOTS) {
                    // å·²å¼€å¦çš„åœŸåœ°
                    userData.plots.push({
                        seed: null,
                        matureAt: 0,
                        gain: 0,
                        exp: 0,
                        unlocked: true
                    });
                } else {
                    // æœªå¼€å¦çš„åœŸåœ°
                    userData.plots.push({
                        seed: null,
                        matureAt: 0,
                        gain: 0,
                        exp: 0,
                        unlocked: false
                    });
                }
            }

            localStorage.setItem(`user_${username}`, JSON.stringify(userData));
            showToast('æ³¨å†ŒæˆåŠŸï¼Œè¯·ç™»å½•å†œåœº');
            document.querySelector('[data-tab="login"]').click();
        }

        function login(username, password, rememberMe = false) {
            const userData = JSON.parse(localStorage.getItem(`user_${username}`));
            if (!userData || userData.password !== password) {
                showToast('ç”¨æˆ·åæˆ–å¯†ç é”™è¯¯');
                return;
            }

            currentUser = userData;
            // å…¼å®¹æ—§æ•°æ®
            if (!currentUser.avatar) currentUser.avatar = defaultAvatars[Math.floor(Math.random() * defaultAvatars.length)];
            if (!currentUser.level) currentUser.level = 1;
            if (!currentUser.exp) currentUser.exp = 0;
            if (!currentUser.warehouse) currentUser.warehouse = { carrot: 0, wheat: 0, tomato: 0 };

            // å…¼å®¹æ—§æ•°æ®ï¼šå¦‚æœæ²¡æœ‰30å—åœŸåœ°ï¼Œè¡¥é½åˆ°30å—
            if (currentUser.plots.length < MAX_PLOTS) {
                const currentLength = currentUser.plots.length;
                for (let i = currentLength; i < MAX_PLOTS; i++) {
                    currentUser.plots.push({
                        seed: null,
                        matureAt: 0,
                        gain: 0,
                        exp: 0,
                        unlocked: false
                    });
                }
            }

            // ç¡®ä¿æ‰€æœ‰åœŸåœ°éƒ½æœ‰unlockedå­—æ®µ
            currentUser.plots.forEach((plot, idx) => {
                if (plot.unlocked === undefined) {
                    plot.unlocked = idx < INITIAL_PLOTS;
                }
            });

            // å¤„ç†è®°ä½å¯†ç åŠŸèƒ½
            if (rememberMe) {
                localStorage.setItem('rememberedUser', username);
                localStorage.setItem('rememberedPassword', password);
            } else {
                localStorage.removeItem('rememberedUser');
                localStorage.removeItem('rememberedPassword');
            }

            localStorage.setItem('currentUser', username);
            showGame();
            startGameLoop();
            showToast('æ¬¢è¿æ¥åˆ°å¼€å¿ƒå†œåœºï¼');
        }

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            stopGameLoop();
            stopAutoSave(); // åœæ­¢è‡ªåŠ¨å­˜æ¡£
            showAuth();
            showToast('å·²é€€å‡ºå†œåœºï¼Œæ¬¢è¿ä¸‹æ¬¡å†æ¥ï¼');
        }

        function saveUserProgress() {
            if (currentUser) {
                localStorage.setItem(`user_${currentUser.username}`, JSON.stringify(currentUser));
                // æ£€æŸ¥æ˜¯å¦éœ€è¦å¤‡ä»½æé†’
                checkBackupReminder();
            }
        }

        // ========== å¯¼å‡º/å¯¼å…¥å­˜æ¡£ ==========
        async function exportSaveData() {
            if (!currentUser) {
                showToast('è¯·å…ˆç™»å½•è´¦å·');
                return;
            }

            // æ”¶é›†æ‰€æœ‰æ•°æ®
            const backupData = {
                version: '1.0',
                exportTime: new Date().toISOString(),
                currentUser: localStorage.getItem('currentUser'),
                rememberedUser: localStorage.getItem('rememberedUser'),
                rememberedPassword: localStorage.getItem('rememberedPassword'),
                users: {}
            };

            // å¯¼å‡ºæ‰€æœ‰ç”¨æˆ·æ•°æ®
            for (let i = 0; i < localStorage.length; i++) {
                const key = localStorage.key(i);
                if (key.startsWith('user_')) {
                    backupData.users[key] = localStorage.getItem(key);
                }
            }

            const dataStr = JSON.stringify(backupData, null, 2);
            const blob = new Blob([dataStr], { type: 'application/json' });

            // æ£€æŸ¥æ˜¯å¦æ”¯æŒ File System Access API
            if ('showSaveFilePicker' in window) {
                try {
                    // å¦‚æœå·²æœ‰æ–‡ä»¶å¥æŸ„ï¼Œç›´æ¥è¦†ç›–
                    if (autoSaveFileHandle) {
                        await writeToFile(autoSaveFileHandle, dataStr);
                        showToast('âœ… å­˜æ¡£å·²æ›´æ–°ï¼');
                    } else {
                        // é¦–æ¬¡å¯¼å‡ºï¼Œè®©ç”¨æˆ·é€‰æ‹©ä½ç½®
                        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                        const options = {
                            suggestedName: `farm-backup-${currentUser.username}-${timestamp}.json`,
                            types: [{
                                description: 'JSON å­˜æ¡£æ–‡ä»¶',
                                accept: { 'application/json': ['.json'] }
                            }]
                        };
                        
                        autoSaveFileHandle = await window.showSaveFilePicker(options);
                        await writeToFile(autoSaveFileHandle, dataStr);
                        
                        // å¯åŠ¨è‡ªåŠ¨å­˜æ¡£
                        startAutoSave();
                        showToast('âœ… å­˜æ¡£å¯¼å‡ºæˆåŠŸï¼Œè‡ªåŠ¨å­˜æ¡£å·²å¼€å¯ï¼');
                    }
                    
                    localStorage.setItem('lastBackupTime', Date.now().toString());
                } catch (error) {
                    if (error.name !== 'AbortError') {
                        console.error('å¯¼å‡ºå¤±è´¥:', error);
                        showToast('âš ï¸ å¯¼å‡ºå¤±è´¥');
                    }
                }
            } else {
                // ä¸æ”¯æŒ File System Access APIï¼Œä½¿ç”¨ä¼ ç»Ÿä¸‹è½½æ–¹å¼
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
                a.download = `farm-backup-${currentUser.username}-${timestamp}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                localStorage.setItem('lastBackupTime', Date.now().toString());
                showToast('âœ… å­˜æ¡£å¯¼å‡ºæˆåŠŸï¼ï¼ˆæµè§ˆå™¨ä¸æ”¯æŒè‡ªåŠ¨å­˜æ¡£ï¼‰');
            }
        }

        // å†™å…¥æ–‡ä»¶
        async function writeToFile(fileHandle, data) {
            const writable = await fileHandle.createWritable();
            await writable.write(data);
            await writable.close();
        }

        // å¯åŠ¨è‡ªåŠ¨å­˜æ¡£ï¼ˆ1åˆ†é’Ÿä¸€æ¬¡ï¼‰
        function startAutoSave() {
            if (autoSaveInterval) return; // å·²å¼€å¯
            
            autoSaveInterval = setInterval(async () => {
                if (autoSaveFileHandle && currentUser) {
                    try {
                        const backupData = {
                            version: '1.0',
                            exportTime: new Date().toISOString(),
                            currentUser: localStorage.getItem('currentUser'),
                            rememberedUser: localStorage.getItem('rememberedUser'),
                            rememberedPassword: localStorage.getItem('rememberedPassword'),
                            users: {}
                        };

                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key.startsWith('user_')) {
                                backupData.users[key] = localStorage.getItem(key);
                            }
                        }

                        const dataStr = JSON.stringify(backupData, null, 2);
                        await writeToFile(autoSaveFileHandle, dataStr);
                        console.log('è‡ªåŠ¨å­˜æ¡£æˆåŠŸ:', new Date().toLocaleTimeString());
                    } catch (error) {
                        console.error('è‡ªåŠ¨å­˜æ¡£å¤±è´¥:', error);
                        // å¦‚æœå¤±è´¥ï¼Œåœæ­¢è‡ªåŠ¨å­˜æ¡£
                        stopAutoSave();
                        showToast('âš ï¸ è‡ªåŠ¨å­˜æ¡£å¤±è´¥ï¼Œå·²å…³é—­');
                    }
                }
            }, 1000); // 1s = 1000æ¯«ç§’
            
            // æ˜¾ç¤ºè‡ªåŠ¨å­˜æ¡£æŒ‡ç¤ºå™¨
            document.getElementById('autoSaveIndicator').classList.add('active');
        }

        // åœæ­¢è‡ªåŠ¨å­˜æ¡£
        function stopAutoSave() {
            if (autoSaveInterval) {
                clearInterval(autoSaveInterval);
                autoSaveInterval = null;
            }
            autoSaveFileHandle = null;
            document.getElementById('autoSaveIndicator').classList.remove('active');
        }

        function importSaveData(event) {
            const file = event.target.files[0];
            if (!file) return;

            // æ£€æŸ¥æ–‡ä»¶ç±»å‹
            if (!file.name.endsWith('.json')) {
                showToast('âš ï¸ è¯·é€‰æ‹©æ­£ç¡®çš„JSONå­˜æ¡£æ–‡ä»¶');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const backupData = JSON.parse(e.target.result);

                    // éªŒè¯æ•°æ®æ ¼å¼
                    if (!backupData.version || !backupData.users) {
                        showToast('âš ï¸ å­˜æ¡£æ–‡ä»¶æ ¼å¼é”™è¯¯');
                        return;
                    }

                    // ç¡®è®¤å¯¼å…¥
                    if (!confirm('å¯¼å…¥å­˜æ¡£å°†è¦†ç›–å½“å‰æ‰€æœ‰æ¸¸æˆæ•°æ®ï¼Œæ˜¯å¦ç»§ç»­ï¼Ÿ')) {
                        event.target.value = ''; // é‡ç½®input
                        return;
                    }

                    // æ¸…ç©ºæ—§æ•°æ®
                    const keysToRemove = [];
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key.startsWith('user_') || key === 'currentUser' || key === 'rememberedUser' || key === 'rememberedPassword') {
                            keysToRemove.push(key);
                        }
                    }
                    keysToRemove.forEach(key => localStorage.removeItem(key));

                    // å¯¼å…¥æ–°æ•°æ®
                    if (backupData.currentUser) {
                        localStorage.setItem('currentUser', backupData.currentUser);
                    }
                    if (backupData.rememberedUser) {
                        localStorage.setItem('rememberedUser', backupData.rememberedUser);
                    }
                    if (backupData.rememberedPassword) {
                        localStorage.setItem('rememberedPassword', backupData.rememberedPassword);
                    }

                    // å¯¼å…¥ç”¨æˆ·æ•°æ®
                    for (const key in backupData.users) {
                        localStorage.setItem(key, backupData.users[key]);
                    }

                    showToast('âœ… å­˜æ¡£å¯¼å…¥æˆåŠŸï¼Œé¡µé¢å°†åˆ·æ–°...');
                    setTimeout(() => {
                        location.reload(); // åˆ·æ–°é¡µé¢åŠ è½½æ–°æ•°æ®
                    }, 1500);

                } catch (error) {
                    console.error('å¯¼å…¥å¤±è´¥:', error);
                    showToast('âš ï¸ å­˜æ¡£æ–‡ä»¶è§£æå¤±è´¥ï¼Œè¯·æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æŸå');
                }
                event.target.value = ''; // é‡ç½®input
            };

            reader.onerror = () => {
                showToast('âš ï¸ æ–‡ä»¶è¯»å–å¤±è´¥');
                event.target.value = '';
            };

            reader.readAsText(file);
        }

        // å¤‡ä»½æé†’æœºåˆ¶ï¼šæ¯éš”1å°æ—¶æé†’ä¸€æ¬¡
        function checkBackupReminder() {
            const lastBackupTime = localStorage.getItem('lastBackupTime');
            const now = Date.now();
            const oneHour = 60 * 60 * 1000; // 1å°æ—¶

            if (!lastBackupTime || (now - parseInt(lastBackupTime)) > oneHour) {
                // ä¸ç«‹å³å¼¹çª—ï¼Œé¿å…å¹²æ‰°æ¸¸æˆï¼Œåªæ˜¾ç¤ºæç¤º
                // å¯ä»¥åœ¨ç‰¹å®šæ—¶æœºæ˜¼ç¤ºï¼Œæ¯”å¦‚æ”¶è·æ—¶ã€å‡çº§æ—¶ç­‰
            }
        }

        // æ˜¾ç¤ºå¤‡ä»½æé†’ï¼ˆåœ¨æ¸¸æˆå¾ªç¯ä¸­è°ƒç”¨ï¼‰
        function showBackupReminderIfNeeded() {
            const lastBackupTime = localStorage.getItem('lastBackupTime');
            const lastRemindTime = localStorage.getItem('lastBackupRemindTime');
            const now = Date.now();
            const oneHour = 60 * 60 * 1000; // 1å°æ—¶

            // å¦‚æœè·ç¦»ä¸Šæ¬¡å¤‡ä»½è¶…è¿‡1å°æ—¶ï¼Œä¸”è·ç¦»ä¸Šæ¬¡æé†’ä¹Ÿè¶…è¿‡1å°æ—¶
            if ((!lastBackupTime || (now - parseInt(lastBackupTime)) > oneHour) &&
                (!lastRemindTime || (now - parseInt(lastRemindTime)) > oneHour)) {
                showToast('ğŸ’¾ æé†’ï¼šå»ºè®®å¯¼å‡ºå­˜æ¡£å¤‡ä»½æ¸¸æˆæ•°æ®ï¼', 5000);
                localStorage.setItem('lastBackupRemindTime', now.toString());
            }
        }

        // ========== å¼€å¦/é“²é™¤åœ°å— ==========
        function reclaimPlot() {
            const reclaimCost = 50;

            // æ‰¾åˆ°ç¬¬ä¸€å—æœªå¼€å¦çš„åœŸåœ°
            const lockedPlotIndex = currentUser.plots.findIndex(p => !p.unlocked);

            if (lockedPlotIndex === -1) {
                showToast(`æ‰€æœ‰åœŸåœ°å·²å¼€å¦å®Œæ¯•ï¼`);
                return;
            }

            if (currentUser.gold >= reclaimCost) {
                currentUser.gold -= reclaimCost;
                currentUser.plots[lockedPlotIndex].unlocked = true;
                saveUserProgress();
                updateUI();
                const unlockedCount = currentUser.plots.filter(p => p.unlocked).length;
                showToast(`æˆåŠŸå¼€å¦æ–°åœ°å—ï¼å½“å‰å·²å¼€å¦ ${unlockedCount} å—åœ°`);
            } else {
                showToast('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•å¼€å¦æ–°åœ°å—ï¼');
            }
        }

        function removePlot() {
            // æ‰¾åˆ°æœ€åä¸€å—å·²å¼€å¦çš„åœŸåœ°ï¼ˆä»åå¾€å‰æ‰¾ï¼‰
            let lastUnlockedIndex = -1;
            for (let i = currentUser.plots.length - 1; i >= INITIAL_PLOTS; i--) {
                if (currentUser.plots[i].unlocked) {
                    lastUnlockedIndex = i;
                    break;
                }
            }

            if (lastUnlockedIndex === -1) {
                showToast(`åˆå§‹${INITIAL_PLOTS}å—åœ°ä¸èƒ½é“²é™¤å“¦ï¼`);
                return;
            }

            // é“²é™¤è¯¥åœ°å—ï¼Œè¿”è¿˜50é‡‘å¸
            currentUser.plots[lastUnlockedIndex] = {
                seed: null,
                matureAt: 0,
                gain: 0,
                exp: 0,
                unlocked: false
            };
            currentUser.gold += 50;
            saveUserProgress();
            updateUI();
            const unlockedCount = currentUser.plots.filter(p => p.unlocked).length;
            showToast(`æˆåŠŸé“²é™¤åœ°å—ï¼è¿”è¿˜50é‡‘å¸ï¼Œå½“å‰å‰©ä½™ ${unlockedCount} å—åœ°`);
        }

        // ========== æ”¶è·åŠŸèƒ½ ==========
        // å•ä¸ªæ”¶è·ï¼ˆå­˜å…¥ä»“åº“+åŠ ç»éªŒï¼‰
        function harvestPlot(idx) {
            const plotData = currentUser.plots[idx];

            if (!plotData.seed || currentUser.gameTime < plotData.matureAt) {
                return false;
            }

            // å­˜å…¥ä»“åº“
            currentUser.warehouse[plotData.seed] += 1;
            // å¢åŠ ç»éªŒ
            currentUser.exp += plotData.exp;
            // é‡ç½®åœ°å—ï¼ˆä¿ç•™unlockedçŠ¶æ€ï¼‰
            currentUser.plots[idx] = {
                seed: null,
                matureAt: 0,
                gain: 0,
                exp: 0,
                unlocked: plotData.unlocked || true  // ä¿ç•™å¼€å¦çŠ¶æ€
            };

            // æ£€æŸ¥å‡çº§
            checkLevelUp();

            saveUserProgress();
            showToast(`æ”¶è·äº†1ä¸ª${seedConfig[plotData.seed].name}ï¼Œè·å¾—${plotData.exp}ç»éªŒï¼`);
            return true;
        }

        // ä¸€é”®æ”¶è·æ‰€æœ‰æˆç†Ÿä½œç‰©
        function harvestAll() {
            let harvestCount = 0;
            let totalExp = 0;

            currentUser.plots.forEach((plotData, idx) => {
                if (plotData.seed && currentUser.gameTime >= plotData.matureAt) {
                    harvestPlot(idx);
                    harvestCount += 1;
                    totalExp += plotData.exp;
                }
            });

            if (harvestCount > 0) {
                updateUI();
                showToast(`ä¸€é”®æ”¶è·å®Œæˆï¼å…±æ”¶è· ${harvestCount} ä¸ªä½œç‰©ï¼Œè·å¾— ${totalExp} ç»éªŒï¼`);
            } else {
                showToast('æš‚æ— æˆç†Ÿçš„ä½œç‰©å¯æ”¶è·ï¼');
            }
        }

        // ========== åŠ é€Ÿé“å…·åŠŸèƒ½ï¼ˆæŒ‰æ¬¡æ‰£è´¹ï¼Œå¯å¤šæ¬¡ä½¿ç”¨ï¼‰ ==========
        function useSpeedProp(idx) {
            const plotData = currentUser.plots[idx];
            const propPrice = Number(document.getElementById('speedPropBtn').dataset.price);

            // æ ¡éªŒæ¡ä»¶
            if (!plotData.seed) {
                showToast('è¿™å—åœ°æ²¡æœ‰ä½œç‰©ï¼Œæ— æ³•ä½¿ç”¨åŠ é€Ÿé“å…·ï¼');
                return;
            }
            if (currentUser.gameTime >= plotData.matureAt) {
                showToast('ä½œç‰©å·²æˆç†Ÿï¼Œæ— éœ€åŠ é€Ÿï¼');
                return;
            }
            if (currentUser.gold < propPrice) {
                showToast('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•ä½¿ç”¨åŠ é€Ÿé“å…·ï¼');
                return;
            }

            // æ‰£é™¤é‡‘å¸ï¼ŒåŠ é€Ÿ5ç§’ï¼ˆå¯å¤šæ¬¡ä½¿ç”¨ï¼‰
            currentUser.gold -= propPrice;
            plotData.matureAt = Math.max(currentUser.gameTime, plotData.matureAt - 5);
            saveUserProgress();
            updateUI();
            showToast(`ä½¿ç”¨åŠ é€Ÿé“å…·æˆåŠŸï¼ä½œç‰©æˆç†Ÿæ—¶é—´å‡å°‘5ç§’ï¼Œå‰©ä½™é‡‘å¸ï¼š${currentUser.gold}`);
        }

        // ========== ç­”é¢˜èµšé‡‘å¸åŠŸèƒ½ ==========
        function openAnswerModal() {
            // éšæœºé€‰ä¸€é“é¢˜
            const randomIdx = Math.floor(Math.random() * questionBank.length);
            currentQuestion = questionBank[randomIdx];

            // æ¸²æŸ“é¢˜ç›®
            document.getElementById('questionTitle').textContent = currentQuestion.question;
            const optionsList = document.getElementById('optionsList');
            optionsList.innerHTML = '';

            currentQuestion.options.forEach((option, idx) => {
                const optionItem = document.createElement('div');
                optionItem.className = 'option-item';
                optionItem.dataset.index = idx;
                optionItem.textContent = option;
                optionsList.appendChild(optionItem);
            });

            // æ˜¾ç¤ºæµ®åŠ¨çª—å£
            document.getElementById('answerModal').style.display = 'block';
        }

        function closeAnswerModal() {
            document.getElementById('answerModal').style.display = 'none';
            currentQuestion = null;
        }

        function handleAnswerSelect(e) {
            if (!currentQuestion || !e.target.classList.contains('option-item')) return;

            const selectedIdx = Number(e.target.dataset.index);
            const allOptions = document.querySelectorAll('.option-item');

            // ç¦ç”¨æ‰€æœ‰é€‰é¡¹
            allOptions.forEach(option => option.style.pointerEvents = 'none');

            if (selectedIdx === currentQuestion.answer) {
                // ç­”å¯¹äº†ï¼Œå¥–åŠ±100é‡‘å¸
                e.target.classList.add('correct');
                currentUser.gold += 100;
                saveUserProgress();
                updateUI();
                updateUserModalUI();
                showToast('å›ç­”æ­£ç¡®ï¼å¥–åŠ±100é‡‘å¸ï¼');
            } else {
                // ç­”é”™äº†ï¼Œæ˜¾ç¤ºæ­£ç¡®ç­”æ¡ˆ
                e.target.classList.add('wrong');
                allOptions[currentQuestion.answer].classList.add('correct');
                showToast('å›ç­”é”™è¯¯ï¼Œå†è¯•è¯•ï¼');
            }
        }

        // ========== ä¸ªäººä¿¡æ¯çª—å£ ==========
        function openUserModal() {
            updateUserModalUI();
            document.getElementById('userModal').style.display = 'block';
        }

        function closeUserModal() {
            document.getElementById('userModal').style.display = 'none';
        }

        // ========== èƒŒåŒ…ç³»ç»Ÿ ==========
        function openBackpack() {
            renderBackpack();
            document.getElementById('backpackModal').style.display = 'block';
        }

        function closeBackpack() {
            document.getElementById('backpackModal').style.display = 'none';
        }

        // æ¸²æŸ“èƒŒåŒ…å†…å®¹
        function renderBackpack() {
            if (!currentUser) return;

            // æ¸²æŸ“ä½œç‰©é¢æ¿
            renderCropsPanel();
            // æ¸²æŸ“ç§å­é¢æ¿
            renderSeedsPanel();
            // æ¸²æŸ“é“å…·é¢æ¿
            renderToolsPanel();
        }

        // æ¸²æŸ“ä½œç‰©é¢æ¿
        function renderCropsPanel() {
            const cropsGrid = document.getElementById('cropsGrid');
            cropsGrid.innerHTML = '';

            let hasAnyCrop = false;
            Object.keys(seedConfig).forEach(cropType => {
                const crop = seedConfig[cropType];
                const count = currentUser.warehouse[cropType];

                if (count > 0) {
                    hasAnyCrop = true;
                    const item = document.createElement('div');
                    item.className = 'backpack-item';
                    item.style.cursor = 'default';
                    item.innerHTML = `
                        <div class="backpack-item-icon">${crop.emoji}</div>
                        <div class="backpack-item-name">${crop.name}</div>
                        <div class="backpack-item-count">æ•°é‡: ${count}</div>
                        <div class="backpack-item-info">å•ä»·: ${crop.gain}é‡‘å¸</div>
                        <div style="margin-top: 10px; width: 100%;">
                            <input type="number" 
                                   class="sell-quantity-input" 
                                   id="sell-input-${cropType}"
                                   min="1" 
                                   max="${count}" 
                                   value="1" 
                                   style="width: 100%; padding: 5px; border: 2px solid #D2B48C; border-radius: 4px; text-align: center; margin-bottom: 5px;">
                            <button class="sell-btn" data-crop="${cropType}" data-mode="partial" 
                                    style="width: 100%; margin-bottom: 3px; font-size: 12px;">
                                å–å‡ºé€‰å®šæ•°é‡
                            </button>
                            <button class="sell-btn" data-crop="${cropType}" data-mode="all" 
                                    style="width: 100%; font-size: 12px; background: linear-gradient(135deg, #DAA520 0%, #FFD700 100%);">
                                å–å‡ºå…¨éƒ¨
                            </button>
                        </div>
                    `;

                    cropsGrid.appendChild(item);

                    // ç»‘å®šå–å‡ºé€‰å®šæ•°é‡æŒ‰é’®äº‹ä»¶
                    item.querySelector('[data-mode="partial"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        const input = document.getElementById(`sell-input-${cropType}`);
                        const quantity = parseInt(input.value) || 1;

                        if (quantity < 1 || quantity > count) {
                            showToast(`è¯·è¾“å…¥1åˆ°${count}ä¹‹é—´çš„æ•°é‡ï¼`);
                            return;
                        }

                        sellCropQuantity(cropType, quantity);
                        renderCropsPanel();
                    });

                    // ç»‘å®šå–å‡ºå…¨éƒ¨æŒ‰é’®äº‹ä»¶
                    item.querySelector('[data-mode="all"]').addEventListener('click', (e) => {
                        e.stopPropagation();
                        sellCrop(cropType);
                        renderCropsPanel();
                    });
                }
            });

            if (!hasAnyCrop) {
                cropsGrid.innerHTML = `
                    <div class="backpack-empty">
                        <div class="backpack-empty-icon">ğŸŒ¾</div>
                        <div class="backpack-empty-text">ä»“åº“é‡Œè¿˜æ²¡æœ‰ä½œç‰©ï¼Œå¿«å»æ”¶è·å§ï¼</div>
                    </div>
                `;
            }
        }

        // æ¸²æŸ“ç§å­é¢æ¿
        function renderSeedsPanel() {
            const seedsGrid = document.getElementById('seedsGrid');
            seedsGrid.innerHTML = '';

            Object.keys(seedConfig).forEach(seedType => {
                const seed = seedConfig[seedType];
                const item = document.createElement('div');
                item.className = 'backpack-item';

                // å¦‚æœå½“å‰é€‰ä¸­äº†è¿™ä¸ªç§å­ï¼Œæ·»åŠ é€‰ä¸­æ ·å¼
                if (selectedSeed && selectedSeed.type === seedType) {
                    item.classList.add('selected');
                }

                item.innerHTML = `
                    <div class="backpack-item-icon">${seed.emoji}</div>
                    <div class="backpack-item-name">${seed.name}ç§å­</div>
                    <div class="backpack-item-info">ä»·æ ¼: ${seed.price}é‡‘å¸</div>
                    <div class="backpack-item-info">æˆç†Ÿ: ${seed.mature}ç§’</div>
                    <div class="backpack-item-info">æ”¶ç›Š: ${seed.gain}é‡‘å¸</div>
                    <div class="backpack-item-info">ç»éªŒ: ${seed.exp}</div>
                `;

                // ç‚¹å‡»é€‰ä¸­ç§å­
                item.addEventListener('click', () => {
                    if (selectedSeed && selectedSeed.type === seedType) {
                        // å–æ¶ˆé€‰ä¸­
                        selectedSeed = null;
                        selectedProp = null;
                        showToast(`å·²å–æ¶ˆé€‰ä¸­${seed.name}ç§å­`);
                    } else {
                        // é€‰ä¸­ç§å­
                        selectedSeed = {
                            type: seedType,
                            price: seed.price,
                            gain: seed.gain,
                            mature: seed.mature,
                            exp: seed.exp
                        };
                        selectedProp = null;
                        showToast(`å·²é€‰ä¸­ ${seed.name}ç§å­ï¼Œå¯è¿ç»­æ’­ç§`);
                    }
                    renderSeedsPanel();
                    renderToolsPanel();
                });

                seedsGrid.appendChild(item);
            });
        }

        // æ¸²æŸ“é“å…·é¢æ¿
        function renderToolsPanel() {
            const toolsGrid = document.getElementById('toolsGrid');
            toolsGrid.innerHTML = '';

            // åŠ é€Ÿé“å…·
            const speedItem = document.createElement('div');
            speedItem.className = 'backpack-item';

            if (selectedProp === 'speed') {
                speedItem.classList.add('selected');
            }

            speedItem.innerHTML = `
                <div class="backpack-item-icon">â©</div>
                <div class="backpack-item-name">åŠ é€Ÿé“å…·</div>
                <div class="backpack-item-info">ä»·æ ¼: 20é‡‘å¸/æ¬¡</div>
                <div class="backpack-item-info">æ•ˆæœ: åŠ é€Ÿ5ç§’</div>
                <div class="backpack-item-info">å¯å¤šæ¬¡ä½¿ç”¨</div>
            `;

            speedItem.addEventListener('click', () => {
                if (selectedProp === 'speed') {
                    selectedProp = null;
                    showToast('å·²å–æ¶ˆé€‰ä¸­åŠ é€Ÿé“å…·');
                } else {
                    selectedProp = 'speed';
                    selectedSeed = null;
                    showToast('å·²é€‰ä¸­åŠ é€Ÿé“å…·ï¼Œç‚¹å‡»ä½œç‰©åœ°å—ä½¿ç”¨ï¼ˆ20é‡‘å¸/æ¬¡ï¼‰');
                }
                renderSeedsPanel();
                renderToolsPanel();
            });

            toolsGrid.appendChild(speedItem);
        }

        // æ›´æ–°ä¸ªäººä¿¡æ¯å¼¹çª—UI
        function updateUserModalUI() {
            if (!currentUser) return;

            const expNeed = getExpNeed(currentUser.level);
            const expPercent = Math.min(100, (currentUser.exp / expNeed) * 100);

            // åŸºæœ¬ä¿¡æ¯
            document.getElementById('modalUserAvatar').textContent = currentUser.avatar;
            document.getElementById('modalUserName').textContent = currentUser.username;
            document.getElementById('modalUserLevel').textContent = `Lv.${currentUser.level}`;
            document.getElementById('modalUserAccount').textContent = currentUser.username;
            document.getElementById('modalUserGold').textContent = currentUser.gold;
            document.getElementById('modalUserExp').textContent = currentUser.exp;
            document.getElementById('modalUserExpNeed').textContent = expNeed;
            document.getElementById('expBar').style.width = `${expPercent}%`;

            // ä»“åº“åˆ—è¡¨
            const warehouseList = document.getElementById('warehouseList');
            warehouseList.innerHTML = '';

            Object.keys(seedConfig).forEach(cropType => {
                const crop = seedConfig[cropType];
                const count = currentUser.warehouse[cropType];

                const item = document.createElement('div');
                item.className = 'warehouse-item';
                item.innerHTML = `
                    <div class="crop-icon">${crop.emoji}</div>
                    <div class="crop-name">${crop.name}</div>
                    <div class="crop-count">æ•°é‡ï¼š${count}</div>
                    <div class="crop-count">å•ä»·ï¼š${crop.gain}é‡‘å¸</div>
                    <button class="sell-btn" data-crop="${cropType}">å–å‡ºå…¨éƒ¨</button>
                `;
                warehouseList.appendChild(item);

                // ç»‘å®šå–å‡ºæŒ‰é’®äº‹ä»¶
                item.querySelector('.sell-btn').addEventListener('click', () => {
                    sellCrop(cropType);
                });
            });
        }

        // ========== æ¸¸æˆæ ¸å¿ƒé€»è¾‘ ==========
        function showGame() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('gameContainer').style.display = 'block';
            updateUserInfoUI();
            updateUI();
        }

        function showAuth() {
            document.getElementById('authContainer').style.display = 'block';
            document.getElementById('gameContainer').style.display = 'none';
        }

        function startGameLoop() {
            if (gameLoopInterval) clearInterval(gameLoopInterval);
            gameLoopInterval = setInterval(() => {
                currentUser.gameTime++;
                updateUI();
                saveUserProgress();
                // æ¯éš”10åˆ†é’Ÿæ£€æŸ¥ä¸€æ¬¡å¤‡ä»½æé†’
                if (currentUser.gameTime % 600 === 0) {
                    showBackupReminderIfNeeded();
                }
            }, 1000);
        }

        function stopGameLoop() {
            if (gameLoopInterval) {
                clearInterval(gameLoopInterval);
                gameLoopInterval = null;
            }
        }

        // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ UI
        function updateUserInfoUI() {
            if (!currentUser) return;

            const expNeed = getExpNeed(currentUser.level);
            document.getElementById('userAvatar').textContent = currentUser.avatar;
            document.getElementById('userName').textContent = currentUser.username;
            document.getElementById('userLevel').textContent = `Lv.${currentUser.level} | ç»éªŒ: ${currentUser.exp}/${expNeed}`;
            document.getElementById('gold').textContent = currentUser.gold;
        }

        function handlePlotClick(idx) {
            const plotData = currentUser.plots[idx];

            // æ£€æŸ¥æ˜¯å¦å·²å¼€å¦
            if (!plotData.unlocked) {
                showToast('è¯·å…ˆå¼€å¦è¿™å—åœŸåœ°ï¼ç‚¹å‡»â€œå¼€å¦æ–°åœ°å—â€æŒ‰é’®');
                return;
            }

            // å¦‚æœé€‰ä¸­äº†é“å…·ï¼Œä¼˜å…ˆä½¿ç”¨é“å…·ï¼ˆå¯å¤šæ¬¡ä½¿ç”¨ï¼Œåªè¦é‡‘å¸è¶³å¤Ÿï¼‰
            if (selectedProp) {
                if (selectedProp === 'speed') {
                    useSpeedProp(idx);
                    // ä¸å–æ¶ˆé€‰ä¸­ï¼Œæ”¯æŒå¤šæ¬¡ç‚¹å‡»ä¸åŒåœ°å—/åŒä¸€åœ°å—ä½¿ç”¨
                    return;
                }
            }

            if (plotData.seed) {
                // æ”¶è·ä½œç‰©ï¼ˆå­˜å…¥ä»“åº“ï¼‰
                if (currentUser.gameTime >= plotData.matureAt) {
                    harvestPlot(idx);
                    updateUI();
                    updateUserInfoUI();
                } else {
                    showToast('ä½œç‰©è¿˜æ²¡æˆç†Ÿï¼Œå†ç­‰ç­‰å§~');
                }
            } else {
                // æ’­ç§
                if (selectedSeed) {
                    if (currentUser.gold >= selectedSeed.price) {
                        currentUser.gold -= selectedSeed.price;
                        currentUser.plots[idx] = {
                            seed: selectedSeed.type,
                            matureAt: currentUser.gameTime + selectedSeed.mature,
                            gain: selectedSeed.gain,
                            exp: selectedSeed.exp,
                            unlocked: true
                        };
                        updateUI();
                        saveUserProgress();
                        showToast(`æˆåŠŸç§ä¸‹ ${seedConfig[selectedSeed.type].name} ç§å­ï¼`);
                    } else {
                        showToast('é‡‘å¸ä¸è¶³ï¼Œæ— æ³•è´­ä¹°ç§å­ï¼');
                    }
                } else {
                    showToast('è¯·å…ˆåœ¨å•†åº—é€‰æ‹©ç§å­~');
                }
            }
        }

        function updateUI() {
            // æ›´æ–°ç”¨æˆ·ä¿¡æ¯æ 
            updateUserInfoUI();

            // æ¸²æŸ“åœ°å—
            const farmContainer = document.getElementById('farm');
            farmContainer.innerHTML = '';
            currentUser.plots.forEach((data, idx) => {
                const plotEl = document.createElement('div');
                plotEl.className = 'plot';
                plotEl.dataset.index = idx;

                // æ£€æŸ¥æ˜¯å¦å·²å¼€å¦
                if (!data.unlocked) {
                    plotEl.classList.add('locked');
                    farmContainer.appendChild(plotEl);
                    plotEl.addEventListener('click', () => handlePlotClick(idx));
                    return;
                }

                if (data.seed) {
                    const matureTime = seedConfig[data.seed].mature;
                    const progress = (currentUser.gameTime - (data.matureAt - matureTime)) / matureTime;

                    if (progress < 0.3) plotEl.classList.add('seedling');
                    else if (progress < 0.9) plotEl.classList.add('growing');
                    else plotEl.classList.add('ready');

                    // è¡¨æƒ…ç¬¦å·ä½œç‰©
                    const cropEmoji = document.createElement('span');
                    cropEmoji.className = 'crop-emoji';
                    cropEmoji.textContent = seedConfig[data.seed].emoji;
                    plotEl.appendChild(cropEmoji);

                    // æ˜¾ç¤ºå‰©ä½™æˆç†Ÿæ—¶é—´
                    const remainingTime = data.matureAt - currentUser.gameTime;
                    const timeDisplay = document.createElement('div');
                    timeDisplay.className = 'crop-time';
                    timeDisplay.textContent = formatTime(remainingTime);
                    plotEl.appendChild(timeDisplay);
                }

                farmContainer.appendChild(plotEl);
                plotEl.addEventListener('click', () => handlePlotClick(idx));
            });

            // æ›´æ–°æ’è¡Œæ¦œ
            updateLeaderboards();
        }

        function showToast(text, duration = 2000) {
            const toastEl = document.getElementById('toast');
            toastEl.textContent = text;
            toastEl.classList.add('show');
            setTimeout(() => toastEl.classList.remove('show'), duration);
        }

        // å¯åŠ¨åº”ç”¨
        init();
    </script>
</body>

</html>